<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Product • AIMC Merch</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="assets/styles.css" />
  </head>
  <body>
    <div class="wrap">
      <header>
        <a class="brand" href="index.html"
          ><i class="fa-solid fa-shirt"></i> AIMC Merch</a
        >
        <div class="header-actions">
          <a class="icon-btn" href="checkout.html"
            ><i class="fa-solid fa-cart-shopping"></i><span>Cart</span
            ><span id="cartBadge" class="badge">0</span></a
          >
        </div>
      </header>

      <div id="detail" class="detail"></div>
    </div>

    <script src="assets/products.js"></script>
    <script src="assets/cart.js"></script>
    <script>
      const money = (n) => `PKR ${Number(n).toLocaleString()}`;
      const qs = new URLSearchParams(location.search);
      const p = (window.PRODUCTS || []).find((x) => x.id === qs.get("id"));
      const root = document.getElementById("detail");

      async function render() {
        if (!p) {
          root.innerHTML = `<div class="card pad">Product not found. <a href="index.html">Back</a></div>`;
          return;
        }

        // Try to get live variants (price+stock) from backend
        let variants = [];
        try {
          variants = await Cart.getVariants(p.id);
        } catch (e) {
          variants = [];
        }

        const vMap = {};
        variants.forEach((v) => (vMap[v.size] = v));

        const sizeList = variants.length
          ? variants.map((v) => v.size)
          : p.sizes || ["S", "M", "L", "XL"];
        const sizeOptions = sizeList
          .map((s) => `<option>${s}</option>`)
          .join("");

        const imgs = p.images?.length ? p.images : [""];
        const thumbs = imgs
          .map(
            (src, i) =>
              `<img src="${src}" data-index="${i}" class="${
                i ? "" : "active"
              }" alt="Photo ${i + 1}">`
          )
          .join("");

        root.innerHTML = `
      <div class="card pad">
        <div class="gallery">
          <div class="zoom-wrap" id="zoom">
            <img class="zoom-img" id="mainImg" src="${imgs[0]}" alt="${p.name}">
            <button id="zoomToggle" class="zoom-toggle">
              <i class="fa-solid fa-magnifying-glass-plus"></i> Zoom
            </button>
          </div>
          <div class="thumbs" id="thumbs">${thumbs}</div>
        </div>
      </div>

      <div class="card pad">
        <div class="section-title">${p.name}</div>
        <div class="muted" style="margin:4px 0">${p.type || ""}</div>
        <div id="priceBox" class="price-lg">${money(p.price)}</div>

        <div class="buy-row">
          <div>
            <label>Size</label>
            <select id="sizeSel" class="input">${sizeOptions}</select>
          </div>
          <div>
            <label>Qty</label>
            <input id="qtySel" type="number" min="1" value="1" class="input">
          </div>
          <div style="align-self:end">
            <button id="addBtn" class="btn">
              <i class="fa-solid fa-cart-plus"></i> Add to cart
            </button>
          </div>
        </div>
        <div id="stockNote" class="muted stock-note"></div>

        <div class="muted" style="margin-top:12px">
          ${p.desc || ""} ${
          imgs.length > 1 ? "Size chart is the last image in the gallery." : ""
        }
        </div>
      </div>
    `;

        // ---------- GALLERY + ZOOM ----------
        const main = document.getElementById("mainImg");
        const thumbsEl = document.getElementById("thumbs");
        const wrap = document.getElementById("zoom");
        const toggle = document.getElementById("zoomToggle");

        let zoomed = false;
        let currentIndex = 0;

        function setXYFromEvent(ev) {
          let clientX, clientY;
          if (ev.touches && ev.touches.length) {
            clientX = ev.touches[0].clientX;
            clientY = ev.touches[0].clientY;
          } else if (ev.changedTouches && ev.changedTouches.length) {
            clientX = ev.changedTouches[0].clientX;
            clientY = ev.changedTouches[0].clientY;
          } else {
            clientX = ev.clientX;
            clientY = ev.clientY;
          }
          const r = wrap.getBoundingClientRect();
          wrap.style.setProperty(
            "--x",
            ((clientX - r.left) / r.width) * 100 + "%"
          );
          wrap.style.setProperty(
            "--y",
            ((clientY - r.top) / r.height) * 100 + "%"
          );
        }

        function applyZoomState() {
          wrap.classList.toggle("zoomed", zoomed);
          toggle.innerHTML = zoomed
            ? '<i class="fa-solid fa-magnifying-glass-minus"></i> Zoom out'
            : '<i class="fa-solid fa-magnifying-glass-plus"></i> Zoom';
        }

        function toggleZoom(force, ev) {
          if (typeof force === "boolean") {
            zoomed = force;
          } else {
            zoomed = !zoomed;
          }
          applyZoomState();
          if (zoomed && ev) {
            setXYFromEvent(ev);
          }
        }

        function showImage(idx) {
          if (!imgs.length) return;
          currentIndex = (idx + imgs.length) % imgs.length; // wrap
          main.src = imgs[currentIndex];

          const allThumbs = thumbsEl.querySelectorAll("img");
          allThumbs.forEach((t, i) => {
            t.classList.toggle("active", i === currentIndex);
          });
        }

        // Thumbnails click
        thumbsEl.addEventListener("click", (e) => {
          const t = e.target.closest("img");
          if (!t) return;
          const idx = Number(t.dataset.index || 0);
          showImage(idx);
        });

        // Mouse move (desktop) while zoomed
        wrap.addEventListener("mousemove", (e) => {
          if (zoomed) setXYFromEvent(e);
        });

        wrap.addEventListener("mouseleave", () => {
          // don't auto-unzoom, just stop following – feels better
        });

        // Click on image area:
        // - if NOT zoomed -> turn zoom ON at click position
        // - if zoomed     -> just move zoom focus
        wrap.addEventListener("click", (e) => {
          if (e.target === toggle || toggle.contains(e.target)) return;
          if (!zoomed) {
            toggleZoom(true, e);
          } else {
            setXYFromEvent(e);
          }
        });

        // Zoom toggle button (desktop + mobile)
        toggle.addEventListener("click", (e) => {
          e.stopPropagation();
          toggleZoom();
        });

        // ---------- TOUCH: SWIPE & PAN ----------
        let touchStartX = null;

        // swipe only when NOT zoomed (when zoomed we pan instead)
        wrap.addEventListener(
          "touchstart",
          (e) => {
            if (!zoomed && e.touches.length === 1) {
              touchStartX = e.touches[0].clientX;
            }
          },
          { passive: true }
        );

        wrap.addEventListener(
          "touchend",
          (e) => {
            if (!zoomed) {
              if (touchStartX === null) return;
              const endX = e.changedTouches[0].clientX;
              const diffX = endX - touchStartX;
              const threshold = 40;
              if (Math.abs(diffX) > threshold) {
                if (diffX < 0) showImage(currentIndex + 1); // swipe left
                else showImage(currentIndex - 1); // swipe right
              }
              touchStartX = null;
            }
          },
          { passive: true }
        );

        // When zoomed, touchmove pans the zoomed image
        wrap.addEventListener(
          "touchmove",
          (e) => {
            if (!zoomed) return;
            setXYFromEvent(e);
          },
          { passive: true }
        );

        // ---------- STOCK + PRICE BY SIZE ----------
        const sizeSel = document.getElementById("sizeSel");
        const priceBox = document.getElementById("priceBox");
        const stockNote = document.getElementById("stockNote");
        const addBtn = document.getElementById("addBtn");

        function updateBySize() {
          const s = sizeSel.value;
          const v = vMap[s];
          const price = v ? Number(v.price || p.price) : p.price;
          const left = v ? Number(v.stock || 0) : undefined;

          priceBox.textContent = money(price);
          if (left === undefined) {
            stockNote.textContent = "";
            addBtn.disabled = false;
            addBtn.style.opacity = 1;
          } else if (left <= 0) {
            stockNote.textContent = "Out of stock";
            addBtn.disabled = true;
            addBtn.style.opacity = 0.6;
          } else if (left <= 10) {
            stockNote.textContent = `Only ${left} left`;
            addBtn.disabled = false;
            addBtn.style.opacity = 1;
          } else {
            stockNote.textContent = "In stock";
            addBtn.disabled = false;
            addBtn.style.opacity = 1;
          }
        }

        sizeSel.addEventListener("change", updateBySize);
        updateBySize();

        // ---------- ADD TO CART ----------
        addBtn.addEventListener("click", (e) => {
          e.preventDefault();
          const size = sizeSel.value;
          const qty = Math.max(
            1,
            parseInt(document.getElementById("qtySel").value || "1")
          );
          const v = vMap[size];
          const price = v ? Number(v.price || p.price) : p.price;

          Cart.add({ id: p.id, name: p.name, size, price, qty });
          refreshCartBadge();
          const old = addBtn.innerHTML;
          addBtn.innerHTML = '<i class="fa-solid fa-check"></i> Added';
          setTimeout(() => (addBtn.innerHTML = old), 1200);
        });

        refreshCartBadge();
      }

      render();
    </script>
  </body>
</html>
