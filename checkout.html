<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Checkout • AIMC Merch</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="assets/styles.css" />
  </head>
  <body>
    <div class="wrap">
      <header>
        <a class="brand" href="index.html">
          <img src="assets/img/AIMC-Merch-Logo.jpeg" alt="AIMC Merch" class="logo">
        </a>
        <div class="header-actions">
          <a class="icon-btn" href="checkout.html"
            ><i class="fa-solid fa-cart-shopping"></i><span>Cart</span
            ><span id="cartBadge" class="badge">0</span></a>
        </div>
      </header>

      <div class="ticker" role="region" aria-label="Announcement">
        <div class="ticker-track">New: Size charts are now available on product pages — please check sizes before ordering • In case of any problem contact us on WhatsApp: <a href="https://wa.me/923036980295" style="color:var(--accent);text-decoration:underline">+92 303 6980295</a></div>
      </div>

      <!-- Cart -->
      <div class="card pad">
        <div class="section-title">Your Cart</div>
        <div class="table-wrap">
          <table class="table" id="cartTable">
            <thead>
              <tr>
                <th>Item</th>
                <th>Size</th>
                <th>Qty</th>
                <th>Price</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Stacked cards for small screens (populated by JS) -->
        <div id="cartCards" class="cart-cards" aria-live="polite"></div>

        <!-- Summary with delivery fee (clean layout) -->
        <div class="summary" style="margin-top: 10px">
          <div class="summary-row">
            <div class="muted">Subtotal</div>
            <div id="subtotal" class="summary-amt">PKR 0</div>
          </div>
          <div class="summary-row" id="feeRow" style="display:none">
            <div class="muted">Delivery fee</div>
            <div id="deliveryFee" class="summary-amt">PKR 0</div>
          </div>
          <div class="summary-row total">
            <div class="muted">Total</div>
            <div id="grandTotal" class="summary-amt">PKR 0</div>
          </div>
        </div>
      </div>

      <!-- Checkout form -->
      <form
        id="checkout"
        class="card pad"
        style="margin-top: 16px"
        enctype="multipart/form-data"
      >
        <div class="section-title">Checkout</div>

        <div class="stack" style="margin-top: 8px">
          <div>
            <label>Full name</label>
            <input name="name" required class="input" autocomplete="name" />
          </div>

          <div>
            <label>Email</label>
            <input
              name="email"
              type="email"
              required
              class="input"
              placeholder="you@example.com"
              autocomplete="email"
            />
          </div>

          <div>
            <label>Phone (WhatsApp)</label>
            <input
              name="phone"
              required
              class="input"
              inputmode="tel"
              autocomplete="tel"
            />
          </div>

          <!-- Discipline -->
          <div>
            <label>Discipline</label>
            <select name="discipline" id="disciplineSel" class="input" required>
              <option value="" disabled selected>Select discipline…</option>
              <option value="MBBS">MBBS</option>
              <option value="DPT">DPT</option>
              <option value="MLT">MLT</option>
              <option value="Nursing">Nursing</option>
              <option value="Allied Health Sciences">
                Allied Health Sciences
              </option>
              <option value="Postgraduate / Doctor">
                Postgraduate / Doctor
              </option>
              <option value="Other">Other</option>
            </select>
          </div>

          <!-- Class / Ward -->
          <div>
            <label>Class / Ward (optional)</label>
            <input
              name="class_ward"
              class="input"
              placeholder="e.g. 3rd Year MBBS, DPT 2nd, Ward 5, etc."
            />
          </div>

          <!-- Other discipline (only visible when 'Other' selected) -->
          <div id="disciplineOtherRow" style="grid-column: 1/-1; display: none">
            <label>Discipline (Other)</label>
            <input
              name="discipline_other"
              id="disciplineOtherInput"
              class="input"
              placeholder="Enter your discipline"
            />
          </div>

          <div>
            <label>Delivery</label>
            <select name="delivery" required class="input" id="deliverySel">
              <option value="Pickup (AIMC Campus)">Pickup (AIMC Campus)</option>
              <option value="Delivery">Delivery</option>
            </select>
          </div>

          <!-- Address (only visible when Delivery is selected) -->
          <div id="addressRow" style="grid-column: 1/-1; display: none">
            <label>Delivery address</label>
            <textarea
              name="address"
              rows="2"
              class="input"
              id="addressField"
              placeholder="House/Street, Area, City. Required for delivery orders."
            ></textarea>
          </div>

          <div>
            <label>Payment method</label>
            <select name="payment_method" required class="input" id="payMethod">
              <option value="" selected disabled>Select payment method…</option>
              <option value="HBL">HBL (Bank Transfer)</option>
              <option value="JAZZCASH">JazzCash / Raast</option>
            </select>
          </div>

          <div>
            <label id="txnLabel">Transaction / Reference ID</label>
            <input
              name="txn_id"
              required
              class="input"
              id="txnInput"
              placeholder="Bank / JazzCash / Raast TXN or reference ID"
            />
          </div>

          <!-- Payment info box (moved up) -->
          <div
            id="paymentInfo"
            style="grid-column: 1/-1; margin-top: 4px"
            class="muted"
          >
            Select a payment method to see account details and instructions.
          </div>

          <div style="grid-column: 1/-1">
            <label>Upload payment screenshot (PNG/JPG)</label>
            <input
              type="file"
              name="screenshot"
              accept="image/*"
              required
              class="input"
              style="padding: 8px"
            />
          </div>

          <div style="grid-column: 1/-1">
            <label>Notes (optional)</label>
            <textarea
              name="notes"
              rows="3"
              class="input"
              placeholder="Any special instructions...."
            ></textarea>
          </div>

          <!-- Honeypot field (hidden from humans, catches bots) -->
          <input type="text" name="confirm_address" style="position:absolute;left:-9999px;" tabindex="-1" autocomplete="off" aria-hidden="true" />
        </div>

        <!-- Mobile summary (will show on small screens) -->
        <div class="summary mobile" style="margin-top:10px">
          <div class="summary-row">
            <div class="muted">Subtotal</div>
            <div id="subtotalMobile" class="summary-amt">PKR 0</div>
          </div>
          <div class="summary-row" id="feeRowMobile" style="display:none">
            <div class="muted">Delivery fee</div>
            <div id="deliveryFeeMobile" class="summary-amt">PKR 0</div>
          </div>
          <div class="summary-row total">
            <div class="muted">Total</div>
            <div id="grandTotalMobile" class="summary-amt">PKR 0</div>
          </div>
        </div>

        <div class="right" style="margin-top: 12px">
          <button type="button" class="btn secondary" id="clear">
            Clear Cart
          </button>
          <button class="btn" type="submit" id="placeOrderBtn">
            Place Order
          </button>
        </div>

        <div id="status" class="status muted"></div>
      </form>
    </div>

    <script src="assets/products.js"></script>
    <script src="assets/cart.js"></script>
    <script>
      // ---------- DOM refs ----------
        const tbody = document.querySelector("#cartTable tbody");
        const subtotalEl = document.getElementById("subtotal");
        const feeRow = document.getElementById("feeRow");
        const feeEl = document.getElementById("deliveryFee");
        const grandEl = document.getElementById("grandTotal");
      const statusEl = document.getElementById("status");

      const paySel = document.getElementById("payMethod");
      const payInfo = document.getElementById("paymentInfo");

      const submitBtn = document.getElementById("placeOrderBtn");
      let isSubmitting = false;
      const submitOrigLabel = submitBtn ? submitBtn.innerHTML : "Place Order";

      const txnLbl = document.getElementById("txnLabel");
      const txnInp = document.getElementById("txnInput");

      const deliverySel = document.getElementById("deliverySel");
      const addressRow = document.getElementById("addressRow");
      const addressField = document.getElementById("addressField");

      const disciplineSel = document.getElementById("disciplineSel");
      const disciplineOtherRow = document.getElementById("disciplineOtherRow");
      const disciplineOtherInput = document.getElementById(
        "disciplineOtherInput"
      );

      // ---------- Helpers ----------
      function formatPKR(n) {
        return `PKR ${Number(n || 0).toLocaleString()}`;
      }
      function calcFee() {
        const v = (deliverySel.value || "").toLowerCase();
        // No fee for pickup or when delivery not selected
        if (!v.includes("delivery")) return 0;

        // Compute total item count from cart (sum of qtys)
        const cart = Cart.load();
        const totalItems = cart.reduce((s, it) => s + (parseInt(it.qty || 0) || 0), 0);
        if (!totalItems) return 0; // guard: empty cart

        // Minimum 250 for the first item, and +50 for every additional item
        return 250 + Math.max(0, totalItems - 1) * 50;
      }

      // ---------- Helpers ----------
      function initials(name) {
        if (!name) return "";
        return name
          .split(" ")
          .map((s) => (s ? s[0] : ""))
          .join("")
          .slice(0, 2)
          .toUpperCase();
      }

      // ---------- Cart render ----------
      function render() {
        const cart = Cart.load();
        const cards = document.getElementById("cartCards");
        if (!cart.length) {
          tbody.innerHTML = `<tr><td colspan="5" class="muted">Your cart is empty.</td></tr>`;
          if (cards) cards.innerHTML = `<div class="muted">Your cart is empty.</div>`;
        } else {
          tbody.innerHTML = cart
            .map(
              (i) => `
          <tr>
            <td>${i.name}</td>
            <td>${i.size}</td>
            <td><input type="number" min="1" value="${i.qty}" class="input" style="width:96px" onchange="updateQty('${i.key}', this.value)"></td>
            <td>${formatPKR(i.price * i.qty)}</td>
            <td><button class="btn secondary" onclick="removeItem('${i.key}');return false;">Remove</button></td>
          </tr>`
            )
            .join("");

          // build stacked cards for small screens
          if (cards) {
            cards.innerHTML = cart
              .map(
                (i) => `
              <div class="cart-card">
                <div class="main">
                  <div class="title">${i.name}</div>
                  <div class="meta">Size: ${i.size}</div>
                </div>
                <div class="controls">
                  <div class="actions">
                    <input type="number" min="1" value="${i.qty}" class="input" onchange="updateQty('${i.key}', this.value)">
                    <button class="btn secondary" onclick="removeItem('${i.key}');return false;">Remove</button>
                    <div class="line2">${formatPKR(i.price * i.qty)}</div>
                  </div>
                </div>
              </div>`
              )
              .join("");
          }
        }
        refreshCartBadge();
        recalcTotals(); // summary
        updatePayInfoAmount(); // amount in payment box (if visible)
      }

      window.updateQty = (key, val) => {
        const c = Cart.load();
        const it = c.find((x) => x.key === key);
        if (it) {
          it.qty = Math.max(1, parseInt(val || 1));
          Cart.save(c);
          render();
        }
      };
      window.removeItem = (key) => {
        const c = Cart.load().filter((i) => i.key !== key);
        Cart.save(c);
        render();
      };
      document.getElementById("clear").addEventListener("click", () => {
        Cart.clear();
        render();
      });

      // ---------- Payment (HBL + JazzCash/Raast) ----------
      const methods = {
        HBL: {
          accountLabel: "HBL Account",
          accountNumber: "12447901757003",
          holder: "Shahab Zafar",
          text: "Transfer to the HBL bank account below. After sending, enter the TXN / Reference ID and upload a screenshot.",
        },
        JAZZCASH: {
          accountLabel: "JazzCash / Raast",
          accountNumber: "03036980295",
          holder: "Shahab Zafar",
          text: "Send the amount via JazzCash or Raast to the mobile number below. After sending, enter the TXN / Reference ID and upload a screenshot.",
        },
      };

      async function copyToClipboard(text, el) {
        try {
          if (navigator.clipboard?.writeText) {
            await navigator.clipboard.writeText(text);
          } else {
            const ta = document.createElement("textarea");
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            ta.remove();
          }
          const orig = el.innerHTML;
          el.innerHTML = "Copied";
          setTimeout(() => (el.innerHTML = orig), 1200);
        } catch {
          alert(
            "Copy failed — please select the account number and copy manually."
          );
        }
      }

      function updatePayInfo() {
        const v = paySel.value;
        if (!v) {
          payInfo.innerHTML =
            "Select a payment method to see account details and instructions.";
          txnLbl.textContent = "Transaction / Reference ID";
          txnInp.placeholder = "Bank / JazzCash / Raast TXN or reference ID";
          return;
        }
        const m = methods[v];
        txnLbl.textContent = "Transaction / Reference ID";
        txnInp.placeholder = "Bank / JazzCash / Raast TXN or reference ID";

        // compute latest amount to transfer (grand total)
        const sub = Cart.subtotal();
        const fee = calcFee();
        const grand = sub + fee;

        payInfo.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:10px">
          <div>${m.text}</div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:2px">
            <div style="flex:1;padding:10px;border-radius:10px;background:var(--card);border:1px solid var(--line);">
              <div style="font-size:13px;color:var(--muted)">${
                m.accountLabel
              } — ${m.holder}</div>
              <div style="margin-top:6px;font-weight:800;word-break:break-all;user-select:text" id="acctNum">${
                m.accountNumber
              }</div>
            </div>
            <button type="button" class="btn secondary" id="copyBtn">Copy</button>
          </div>
          <div style="padding:10px;border-radius:10px;background:var(--card);border:1px solid var(--line);display:flex;justify-content:space-between;align-items:center">
            <div class="muted">Amount to transfer</div>
            <div id="payAmount" style="font-weight:800">${formatPKR(
              grand
            )}</div>
          </div>
        </div>
      `;

        // wire copy
        const copyBtn = document.getElementById("copyBtn");
        const acctNum = document.getElementById("acctNum").textContent;
        copyBtn.addEventListener("click", () =>
          copyToClipboard(acctNum, copyBtn)
        );
      }

      // Only update the amount text inside the payment box (no full re-render)
      function updatePayInfoAmount() {
        const amtEl = document.getElementById("payAmount");
        if (!amtEl) return; // not selected yet
        const sub = Cart.subtotal();
        const fee = calcFee();
        amtEl.textContent = formatPKR(sub + fee);
      }

      paySel.addEventListener("change", () => {
        updatePayInfo();
      });

      // ---------- Address UI + totals ----------
      function updateAddressUI() {
        const need = (deliverySel.value || "").includes("Delivery");
        addressRow.style.display = need ? "" : "none";
        addressField.required = need;
        if (!need) addressField.value = "";
      }

      function recalcTotals() {
        const sub = Cart.subtotal();
        const fee = calcFee();
        const grand = sub + fee;

        subtotalEl.textContent = formatPKR(sub);
        grandEl.textContent = formatPKR(grand);
        // also update mobile summary if present
        const subM = document.getElementById("subtotalMobile");
        const feeRowM = document.getElementById("feeRowMobile");
        const feeElM = document.getElementById("deliveryFeeMobile");
        const grandM = document.getElementById("grandTotalMobile");
        if (subM) subM.textContent = formatPKR(sub);
        if (grandM) grandM.textContent = formatPKR(grand);

        if (fee > 0) {
          if (feeRow) feeRow.style.display = "";
          if (feeEl) feeEl.textContent = formatPKR(fee);
          if (feeRowM) feeRowM.style.display = "";
          if (feeElM) feeElM.textContent = formatPKR(fee);
        } else {
          if (feeRow) feeRow.style.display = "none";
          if (feeRowM) feeRowM.style.display = "none";
        }
      }

      deliverySel.addEventListener("change", () => {
        updateAddressUI();
        recalcTotals();
        updatePayInfoAmount();
      });

      // ---------- Discipline UI ----------
      function updateDisciplineUI() {
        if (!disciplineSel) return;
        const val = disciplineSel.value || "";
        const isOther = val === "Other";
        disciplineOtherRow.style.display = isOther ? "" : "none";
        disciplineOtherInput.required = isOther;
        if (!isOther) disciplineOtherInput.value = "";
      }

      disciplineSel.addEventListener("change", updateDisciplineUI);

      // ---------- Validation helpers ----------
      function isValidEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
      }

      function isValidPhone(phone) {
        // Pakistani phone: 11 digits starting with 0, or 10 digits, or with +92
        const cleaned = phone.replace(/[\s\-()]/g, '');
        return /^(\+92|0)?[0-9]{10,11}$/.test(cleaned);
      }

      function checkRateLimit() {
        const lastSubmit = localStorage.getItem('lastOrderSubmit');
        if (!lastSubmit) return true;
        const elapsed = Date.now() - parseInt(lastSubmit);
        const cooldown = 30000; // 30 seconds
        if (elapsed < cooldown) {
          const remaining = Math.ceil((cooldown - elapsed) / 1000);
          return { blocked: true, remaining };
        }
        return { blocked: false };
      }

      // ---------- Submit ----------
      document
        .getElementById("checkout")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          // HARD GUARD: ignore if already submitting
          if (isSubmitting) return;

          // 1. Check honeypot (bot trap)
          const honeypot = e.target.querySelector('[name="confirm_address"]');
          if (honeypot && honeypot.value) {
            statusEl.innerHTML = '<span class="err">❌ Submission failed. Please try again.</span>';
            return;
          }

          // 2. Validate cart not empty
          const cart = Cart.load();
          if (!cart.length) {
            statusEl.innerHTML = '<span class="err">❌ Your cart is empty. Please add items before checkout.</span>';
            return;
          }

          // 3. Validate email format
          const emailInput = e.target.querySelector('[name="email"]');
          if (!isValidEmail(emailInput.value)) {
            statusEl.innerHTML = '<span class="err">❌ Please enter a valid email address.</span>';
            emailInput.focus();
            return;
          }

          // 4. Validate phone format
          const phoneInput = e.target.querySelector('[name="phone"]');
          if (!isValidPhone(phoneInput.value)) {
            statusEl.innerHTML = '<span class="err">❌ Please enter a valid Pakistani phone number (e.g., 03001234567).</span>';
            phoneInput.focus();
            return;
          }

          // 5. Rate limiting check
          const rateCheck = checkRateLimit();
          if (rateCheck.blocked) {
            statusEl.innerHTML = `<span class="err">❌ Please wait ${rateCheck.remaining} seconds before placing another order.</span>`;
            return;
          }

          // 6. Validate screenshot upload
          const screenshotInput = e.target.querySelector('[name="screenshot"]');
          if (!screenshotInput.files || !screenshotInput.files[0]) {
            statusEl.innerHTML = '<span class="err">❌ Please upload a payment screenshot before submitting.</span>';
            screenshotInput.focus();
            return;
          }

          isSubmitting = true;

          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = "Submitting…";
          }

          statusEl.textContent = "Submitting...";

          try {
            const res = await Cart.submitOrder(e.target); // sends cart_json + total + delivery_fee
            if (res.ok) {
              // Store timestamp for rate limiting
              localStorage.setItem('lastOrderSubmit', Date.now().toString());
              
              statusEl.innerHTML = `<span class="ok">✅ Order placed!</span> Order ID: <b>${
                res.orderId
              }</b>. Total: <b>${formatPKR(
                res.total || 0
              )}</b>. We'll confirm on WhatsApp.`;
              Cart.clear();
              render();
              e.target.reset();
              updatePayInfo();
              updateAddressUI();
              updateDisciplineUI();
            } else if (res.reason === "out_of_stock") {
              const lines = res.shortages
                .map(
                  (s) =>
                    `• <b>${s.id}</b> (${s.size}) — requested ${s.requested}, available ${s.available}`
                )
                .join("<br>");
              statusEl.innerHTML = `<span class="err">❌ Not enough stock:</span><br>${lines}<br><span class="muted">Please adjust quantities/sizes and try again.</span>`;
            } else {
              statusEl.innerHTML = `<span class="err">❌ Error:</span> ${
                res.error || "Submit failed"
              }`;
            }
          } catch (err) {
            statusEl.innerHTML = `<span class="err">❌ Error:</span> ${
              err.message || err
            }`;
          } finally {
            isSubmitting = false;
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.innerHTML = submitOrigLabel;
            }
          }
        });

      // ---------- Init ----------
      updateAddressUI();
      updatePayInfo(); // initial message
      updateDisciplineUI();
      render(); // draws cart and totals
    </script>

    
  </body>
</html>
