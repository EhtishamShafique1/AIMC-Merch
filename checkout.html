<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Checkout • AIMC Merch</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="assets/styles.css" />
  </head>
  <body>
    <div class="wrap">
      <header>
        <a class="brand" href="index.html"
          ><i class="fa-solid fa-shirt"></i> AIMC Merch</a
        >
        <div class="header-actions">
          <a class="icon-btn" href="checkout.html"
            ><i class="fa-solid fa-cart-shopping"></i><span>Cart</span
            ><span id="cartBadge" class="badge">0</span></a
          >
        </div>
      </header>

      <!-- Cart -->
      <div class="card pad">
        <div class="section-title">Your Cart</div>
        <div class="table-wrap">
          <table class="table" id="cartTable">
            <thead>
              <tr>
                <th>Item</th>
                <th>Size</th>
                <th>Qty</th>
                <th>Price</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Summary with delivery fee -->
        <div class="right" style="margin-top: 10px; gap: 16px; flex-wrap: wrap">
          <div class="muted">Subtotal:</div>
          <div id="subtotal" style="font-weight: 800">PKR 0</div>
          <div class="muted" id="feeLabel" style="display: none">
            • Delivery fee:
          </div>
          <div id="deliveryFee" style="font-weight: 800; display: none">
            PKR 0
          </div>
          <div class="muted">• Total:</div>
          <div id="grandTotal" style="font-weight: 800">PKR 0</div>
        </div>
      </div>

      <!-- Checkout form -->
      <form
        id="checkout"
        class="card pad"
        style="margin-top: 16px"
        enctype="multipart/form-data"
      >
        <div class="section-title">Checkout</div>

        <div class="stack" style="margin-top: 8px">
          <div>
            <label>Full name</label>
            <input name="name" required class="input" autocomplete="name" />
          </div>
          <div>
            <label>Email</label>
            <input
              name="email"
              type="email"
              required
              class="input"
              placeholder="you@example.com"
              autocomplete="email"
            />
          </div>
          <div>
            <label>Phone (WhatsApp)</label>
            <input
              name="phone"
              required
              class="input"
              inputmode="tel"
              autocomplete="tel"
            />
          </div>

          <div>
            <label>Delivery</label>
            <select name="delivery" required class="input" id="deliverySel">
              <option value="Pickup (Campus)">Pickup (Campus)</option>
              <option value="Delivery (Lahore)">Delivery (Lahore)</option>
            </select>
          </div>

          <!-- Address (only visible when Delivery is selected) -->
          <div id="addressRow" style="grid-column: 1/-1; display: none">
            <label>Delivery address</label>
            <textarea
              name="address"
              rows="2"
              class="input"
              id="addressField"
              placeholder="House/Street, Area, City. Required for delivery orders."
            ></textarea>
          </div>

          <div>
            <label>Payment method</label>
            <select name="payment_method" required class="input" id="payMethod">
              <option value="" selected disabled>Select payment method…</option>
              <option value="HBL">HBL (Bank Transfer)</option>
              <option value="ABL">ABL (Bank Transfer)</option>
            </select>
          </div>

          <div>
            <label id="txnLabel">Transaction ID</label>
            <input
              name="txn_id"
              required
              class="input"
              id="txnInput"
              placeholder="Enter the bank TXN / reference ID"
            />
          </div>

          <div style="grid-column: 1/-1">
            <label>Upload payment screenshot (PNG/JPG)</label>
            <input
              type="file"
              name="screenshot"
              accept="image/*"
              required
              class="input"
              style="padding: 8px"
            />
          </div>

          <div style="grid-column: 1/-1">
            <label>Notes (optional)</label>
            <textarea
              name="notes"
              rows="3"
              class="input"
              placeholder="Any special instructions, name on jersey, etc."
            ></textarea>
          </div>
        </div>

        <!-- Dynamic bank details (copyable) + amount to transfer -->
        <div id="paymentInfo" class="muted" style="margin-top: 8px">
          Select a payment method to see account details and instructions.
        </div>

        <div class="right" style="margin-top: 12px">
          <button type="button" class="btn secondary" id="clear">
            Clear Cart
          </button>
          <button class="btn" type="submit">Place Order</button>
        </div>

        <div id="status" class="status muted"></div>
      </form>
    </div>

    <script src="assets/products.js"></script>
    <script src="assets/cart.js"></script>
    <script>
      // ---------- DOM refs ----------
      const tbody = document.querySelector("#cartTable tbody");
      const subtotalEl = document.getElementById("subtotal");
      const feeLabelEl = document.getElementById("feeLabel");
      const feeEl = document.getElementById("deliveryFee");
      const grandEl = document.getElementById("grandTotal");
      const statusEl = document.getElementById("status");

      const paySel = document.getElementById("payMethod");
      const payInfo = document.getElementById("paymentInfo");
      const txnLbl = document.getElementById("txnLabel");
      const txnInp = document.getElementById("txnInput");

      const deliverySel = document.getElementById("deliverySel");
      const addressRow = document.getElementById("addressRow");
      const addressField = document.getElementById("addressField");

      // ---------- Helpers ----------
      function formatPKR(n) {
        return `PKR ${Number(n || 0).toLocaleString()}`;
      }
      function calcFee() {
        const v = (deliverySel.value || "").toLowerCase();
        return v.includes("delivery") ? 200 : 0;
      }

      // ---------- Cart render ----------
      function render() {
        const cart = Cart.load();
        if (!cart.length) {
          tbody.innerHTML = `<tr><td colspan="5" class="muted">Your cart is empty.</td></tr>`;
        } else {
          tbody.innerHTML = cart
            .map(
              (i) => `
          <tr>
            <td>${i.name}</td>
            <td>${i.size}</td>
            <td><input type="number" min="1" value="${
              i.qty
            }" class="input" style="width:96px" onchange="updateQty('${
                i.key
              }', this.value)"></td>
            <td>${formatPKR(i.price * i.qty)}</td>
            <td><button class="btn secondary" onclick="removeItem('${
              i.key
            }');return false;">Remove</button></td>
          </tr>`
            )
            .join("");
        }
        refreshCartBadge();
        recalcTotals(); // summary
        updatePayInfoAmount(); // amount in payment box (if visible)
      }

      window.updateQty = (key, val) => {
        const c = Cart.load();
        const it = c.find((x) => x.key === key);
        if (it) {
          it.qty = Math.max(1, parseInt(val || 1));
          Cart.save(c);
          render();
        }
      };
      window.removeItem = (key) => {
        const c = Cart.load().filter((i) => i.key !== key);
        Cart.save(c);
        render();
      };
      document.getElementById("clear").addEventListener("click", () => {
        Cart.clear();
        render();
      });

      // ---------- Payment (Bank only) ----------
      const methods = {
        HBL: {
          accountLabel: "HBL Account",
          accountNumber: "12447901757003",
          holder: "Shahab Zafar",
          text: "Transfer to the bank account below. After sending, enter the Bank TXN / Reference ID and upload a screenshot.",
        },
        ABL: {
          accountLabel: "ABL Account",
          accountNumber: "53580020056014000012",
          holder: "Shahab Zafar",
          text: "Transfer to the bank account below. After sending, enter the Bank TXN / Reference ID and upload a screenshot.",
        },
      };

      async function copyToClipboard(text, el) {
        try {
          if (navigator.clipboard?.writeText) {
            await navigator.clipboard.writeText(text);
          } else {
            const ta = document.createElement("textarea");
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            ta.remove();
          }
          const orig = el.innerHTML;
          el.innerHTML = "Copied";
          setTimeout(() => (el.innerHTML = orig), 1200);
        } catch {
          alert(
            "Copy failed — please select the account number and copy manually."
          );
        }
      }

      function updatePayInfo() {
        const v = paySel.value;
        if (!v) {
          payInfo.innerHTML =
            "Select a payment method to see account details and instructions.";
          txnLbl.textContent = "Transaction ID";
          txnInp.placeholder = "Enter the bank TXN / reference ID";
          return;
        }
        const m = methods[v];
        txnLbl.textContent = "Transaction ID (Bank transfer)";
        txnInp.placeholder = "Bank TXN / Reference ID";

        // compute latest amount to transfer (grand total)
        const sub = Cart.subtotal();
        const fee = calcFee();
        const grand = sub + fee;

        payInfo.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:10px">
          <div>${m.text}</div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:2px">
            <div style="flex:1;padding:10px;border-radius:10px;background:var(--card);border:1px solid var(--line);">
              <div style="font-size:13px;color:var(--muted)">${
                m.accountLabel
              } — ${m.holder}</div>
              <div style="margin-top:6px;font-weight:800;word-break:break-all;user-select:text" id="acctNum">${
                m.accountNumber
              }</div>
            </div>
            <button type="button" class="btn secondary" id="copyBtn">Copy</button>
          </div>
          <div style="padding:10px;border-radius:10px;background:var(--card);border:1px solid var(--line);display:flex;justify-content:space-between;align-items:center">
            <div class="muted">Amount to transfer</div>
            <div id="payAmount" style="font-weight:800">${formatPKR(
              grand
            )}</div>
          </div>
        </div>
      `;

        // wire copy
        const copyBtn = document.getElementById("copyBtn");
        const acctNum = document.getElementById("acctNum").textContent;
        copyBtn.addEventListener("click", () =>
          copyToClipboard(acctNum, copyBtn)
        );
      }

      // Only update the amount text inside the payment box (no full re-render)
      function updatePayInfoAmount() {
        const amtEl = document.getElementById("payAmount");
        if (!amtEl) return; // not selected yet
        const sub = Cart.subtotal();
        const fee = calcFee();
        amtEl.textContent = formatPKR(sub + fee);
      }

      paySel.addEventListener("change", () => {
        updatePayInfo();
      });

      // ---------- Address UI + totals ----------
      function updateAddressUI() {
        const need = (deliverySel.value || "").includes("Delivery");
        addressRow.style.display = need ? "" : "none";
        addressField.required = need;
        if (!need) addressField.value = "";
      }

      function recalcTotals() {
        const sub = Cart.subtotal();
        const fee = calcFee();
        const grand = sub + fee;

        subtotalEl.textContent = formatPKR(sub);
        grandEl.textContent = formatPKR(grand);

        if (fee > 0) {
          feeLabelEl.style.display = "inline";
          feeEl.style.display = "inline";
          feeEl.textContent = formatPKR(fee);
        } else {
          feeLabelEl.style.display = "none";
          feeEl.style.display = "none";
        }
      }

      deliverySel.addEventListener("change", () => {
        updateAddressUI();
        recalcTotals();
        updatePayInfoAmount();
      });

      // ---------- Submit ----------
      document
        .getElementById("checkout")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          statusEl.textContent = "Submitting...";
          try {
            const res = await Cart.submitOrder(e.target); // sends cart_json + total + delivery_fee
            if (res.ok) {
              statusEl.innerHTML = `<span class="ok">✅ Order placed!</span> Order ID: <b>${
                res.orderId
              }</b>. Total: <b>${formatPKR(
                res.total || 0
              )}</b>. We’ll confirm on WhatsApp.`;
              Cart.clear();
              render();
              e.target.reset();
              updatePayInfo();
              updateAddressUI();
            } else if (res.reason === "out_of_stock") {
              const lines = res.shortages
                .map(
                  (s) =>
                    `• <b>${s.id}</b> (${s.size}) — requested ${s.requested}, available ${s.available}`
                )
                .join("<br>");
              statusEl.innerHTML = `<span class="err">❌ Not enough stock:</span><br>${lines}<br><span class="muted">Please adjust quantities/sizes and try again.</span>`;
            } else {
              statusEl.innerHTML = `<span class="err">❌ Error:</span> ${
                res.error || "Submit failed"
              }`;
            }
          } catch (err) {
            statusEl.innerHTML = `<span class="err">❌ Error:</span> ${
              err.message || err
            }`;
          }
        });

      // ---------- Init ----------
      updateAddressUI();
      updatePayInfo(); // initial message
      render(); // draws cart and totals
    </script>
  </body>
</html>
